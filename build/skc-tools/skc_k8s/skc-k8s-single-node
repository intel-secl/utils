TARGETS = sgx-caching-service sgx-verification-service sgx-hvs

all: clean intel_secl_k8s $(TARGETS) k8s-extensions sgx_agent skc_library
	mkdir -p k8s/container-images
	mkdir -p k8s/manifests
	mkdir -p k8s/platform-dependencies
	cp -r utils/build/skc-tools/sgx_agent/agent_untar.sh k8s/platform-dependencies/
	cp -r utils/build/skc-tools/sgx_agent/build_scripts/sgx_agent.tar k8s/platform-dependencies/
	cp -r utils/build/skc-tools/sgx_agent/build_scripts/sgx_agent.sha2 k8s/platform-dependencies/
	cp -r utils/build/skc-tools/sgx_agent/deploy_scripts/agent_container_prereq.sh k8s/platform-dependencies/
	cp -r utils/build/skc-tools/sgx_agent/deploy_scripts/deployment_prerequisites.sh k8s/platform-dependencies/
	cp -r utils/build/skc-tools/sgx_agent/deploy_scripts/create_roles.conf utils/build/skc-tools/skc_k8s/skc_library/resources/
	cp -r utils/build/skc-tools/sgx_agent/deploy_scripts/skc_library_create_roles.sh utils/build/skc-tools/skc_k8s/skc_library/resources/
	cp -r utils/build/skc-tools/sgx_agent/deploy_scripts/skc_library.conf utils/build/skc-tools/skc_k8s/skc_library/resources/
	cp -r utils/build/skc-tools/skc_k8s/db-deployments/single-node/* k8s/manifests/
	cp utils/build/skc-tools/skc_k8s/isecl-skc-k8s.env k8s/manifests/isecl-skc-k8s.env
	cp -r utils/build/skc-tools/skc_k8s/pre-requisites.sh k8s/manifests/
	cp -r utils/build/skc-tools/skc_k8s/db-deployments/skc-bootstrap-db-services.sh k8s/manifests/skc-bootstrap-db-services.sh
	cp -r utils/build/skc-tools/skc_k8s/single-node/* k8s/manifests/
	cp -r utils/build/skc-tools/skc_k8s/skc-bootstrap.sh k8s/manifests/skc-bootstrap.sh
	cp -r utils/build/skc-tools/skc_k8s/sgx_agent k8s/manifests/sgx_agent
	cp -r utils/build/skc-tools/skc_k8s/skc_library k8s/manifests/skc_library
	cp -r utils/build/skc-tools/skc_k8s/k8s-extensions-controller k8s/manifests/
	cp -r utils/build/skc-tools/skc_k8s/k8s-extensions-scheduler k8s/manifests/
	cp intel-secl/deployments/container-archive/oci/* k8s/container-images/
	mkdir -p k8s/manifests/aas/scripts
	cp intel-secl/deployments/k8s/aas/populate-users k8s/manifests/aas/scripts/
	cp intel-secl/deployments/k8s/aas/populate-users.env k8s/manifests/aas/scripts/populate-users.env
	cp -r utils/build/skc-tools/kbs_script k8s/manifests/kbs/
	cp k8s-extensions/out/isecl-k8s-extensions/*.tar k8s/container-images/
	cp sgx-caching-service/out/*.tar k8s/container-images/
	cp sgx-verification-service/out/*.tar k8s/container-images/
	cp sgx-hvs/out/*.tar k8s/container-images/
	cp sgx_agent/out/*.tar k8s/container-images/
	cp skc_library/out/*.tar k8s/container-images/

clean: $(patsubst %, %-clean, $(TARGETS))
	rm -rf k8s/

sgx_agent:
	cd utils/build/skc-tools/sgx_agent/build_scripts/ && ./build_sgx_agent_docker.sh

skc_library:
	cd utils/build/skc-tools/skc_library/build_scripts/ && ./build_skclib_docker.sh

intel_secl_k8s:
	cd intel-secl && make k8s

$(TARGETS):
	cd $@ && make oci-archive

k8s-extensions:
	cd k8s-extensions && make all

%-clean:
	cd $* && make clean
	cd intel-secl && make clean
	cd k8s-extensions && make clean

.PHONY: all clean sgx_agent skc_library $(TARGETS) k8s-extensions
