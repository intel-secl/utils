# Copyright (C) 2021  Intel Corporation
# SPDX-License-Identifier: BSD-3-Clause

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: skclib-deployment
  namespace: isecl
  labels:
    env: demo
    app: skclib
spec:
  replicas: 1
  selector:
    matchLabels:
      app: skclib
  template:
    metadata:
      labels:
        app: skclib
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: node.type
                    operator: In
                    values:
                      - "SGX-ENABLED"
      containers:
        - name: skc-lib
          image: <image>:<tag>
          imagePullPolicy: Always
          ports:
           - containerPort: 8080
           - containerPort: 2443
          envFrom:
            - configMapRef:
                name: nginx-config
            - configMapRef:
                name: kbs-key-config
            - configMapRef:
                name: sgx-qcnl-config
            - configMapRef:
                name: openssl-config
            - configMapRef:
                name: pkcs11-config
            - configMapRef:
                name: haproxy-hosts-config
          volumeMounts:
           - mountPath: /var/log/nginx
             name: nginx-log-volume
           - mountPath: /etc/nginx/nginx.conf
             name: nginx-config-volume
             subPath: nginx.conf
           - mountPath: /root/keys.txt
             name: kbs-key-volume
             subPath: keys.txt
           - mountPath: /etc/sgx_default_qcnl.conf
             name: sgx-qcnl-config
             subPath: sgx_default_qcnl.conf
           - mountPath: /etc/pki/tls/openssl.cnf
             name: openssl-config-volume
             subPath: openssl.cnf
           - mountPath: /opt/skc/etc/pkcs11-apimodule.ini
             name: pkcs11-config-volume
             subPath: pkcs11-apimodule.ini
           - mountPath: /opt/skc/etc/sgx_stm.ini
             name: sgx-stm-config-volume
             subPath: sgx_stm.ini
           - mountPath: /opt/skc/etc/npm.ini
             name: kbs-npm-config-volume
             subPath: npm.ini
           - mountPath: /etc/hosts
             name: haproxy-hosts
             subPath: hosts
           - mountPath: /opt/skc/store/cms-ca.cert
             name: cmsca-secret-volume
             subPath: cms-ca.cert
             readOnly: true
           - mountPath: /root/nginx.crt
             name: kbs-cert-secret-volume
             subPath: nginx.crt
             readOnly: true
           - name: sagent-sgx-device
             mountPath: /dev/sgx/
          securityContext:
             privileged: true
      volumes:
        - hostPath:
             path: /var/log/nginx
          name: nginx-log-volume
        - name: nginx-config-volume
          configMap:
             name: nginx-config
        - name: kbs-key-volume
          configMap:
             name: kbs-key-config
        - name: sgx-qcnl-config
          configMap:
             name: sgx-qcnl-config
        - name: openssl-config-volume
          configMap:
             name: openssl-config
        - name: pkcs11-config-volume
          configMap:
             name: pkcs11-config
        - name: sgx-stm-config-volume
          configMap:
             name: sgx-stm-config
        - name: kbs-npm-config-volume
          configMap:
             name: kbs-npm-config
        - name: haproxy-hosts
          configMap:
             name: haproxy-hosts-config
        - name: kbs-cert-secret-volume
          secret:
              secretName: kbs-cert-secret
        - name: cmsca-secret-volume
          secret:
              secretName: cmsca-cert-secret
        - name: sagent-sgx-device
          hostPath:
            path: /dev/sgx/
            type: DirectoryOrCreate

