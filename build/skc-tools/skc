TARGETS = sgx-caching-service sgx-verification-service sgx-hvs
COMMON_TARGETS = authservice cms ihub kbs

binaries: clean $(COMMON_TARGETS) skc_installer sgx_agent skc_library k8s_extensions
	mkdir -p binaries/env
	cp sgx-caching-service/out/*.bin binaries/
	cp sgx-caching-service/dist/linux/scs.env binaries/env
	cp sgx-verification-service/out/*.bin binaries/
	cp sgx-verification-service/dist/linux/sqvs.env binaries/env
	cp sgx-verification-service/dist/linux/trusted_rootca.pem binaries/
	cp sgx-hvs/out/*.bin binaries/
	cp sgx-hvs/dist/linux/shvs.env binaries/env
	cp intel-secl/deployments/installer/*.bin binaries/
	cp intel-secl/deployments/installer/*.sh binaries/
	cp intel-secl/tools/aas-manager/populate-users.env binaries/env
	cp k8s-extensions/out/isecl-k8s-extensions-*.tar.gz binaries/
	cp utils/build/skc-tools/sgx_agent/build_scripts/sgx_agent.* binaries/
	cp utils/build/skc-tools/sgx_agent/agent_untar.sh binaries/
	cp utils/build/skc-tools/skc_library/build_scripts/skc_library.* binaries/
	cp utils/build/skc-tools/skc_library/skclib_untar.sh binaries/
	cp -pf utils/build/skc-tools/skc_scripts/env/*.env binaries/env
	cp -pf utils/build/skc-tools/skc_scripts/env/install_pg.sh binaries/
	cp -pf utils/build/skc-tools/skc_scripts/install_*.sh binaries/
	cp -pf utils/build/skc-tools/skc_scripts/*.conf binaries/
	cp -rpf utils/build/skc-tools/kbs_script/ binaries/

k8s-aio: clean intel_secl_k8s skc_k8s k8s_extensions sgx_agent_k8s skc_library_k8s k8s_common
	cp -r utils/build/skc-tools/skc_k8s/db-deployments/single-node/* k8s/manifests/
	cp -r utils/build/skc-tools/skc_k8s/single-node/* k8s/manifests/
	mkdir -p k8s/manifests/aas/scripts
	cp intel-secl/deployments/k8s/aas/populate-users k8s/manifests/aas/scripts/
	cp intel-secl/deployments/k8s/aas/populate-users.env k8s/manifests/aas/scripts/populate-users.env

k8s: clean $(K8S_TARGETS) intel_secl_k8s skc_k8s k8s_extensions sgx_agent_k8s skc_library_k8s k8s_common
	cp -r utils/build/skc-tools/skc_k8s/db-deployments/multi-node/* k8s/manifests/
	cp -r intel-secl/deployments/k8s/* k8s/manifests/
	cp -r utils/build/skc-tools/skc_k8s/create-skc-dirs-nfs.sh k8s/
	cp -r sgx-caching-service/out/k8s k8s/manifests/scs
	cp -r sgx-verification-service/out/k8s k8s/manifests/sqvs
	cp -r sgx-hvs/out/k8s k8s/manifests/shvs
	mkdir -p k8s/manifests/aas/scripts
	mv k8s/manifests/aas/populate-users k8s/manifests/aas/scripts/
	mv k8s/manifests/aas/populate-users.env k8s/manifests/aas/scripts/

clean: $(patsubst %, %-clean, $(TARGETS))
	rm -rf binaries/
	rm -rf k8s/

sgx_agent:
	cd utils/build/skc-tools/sgx_agent/build_scripts/ && ./sgxagent_build.sh
	
skc_library:
	cd utils/build/skc-tools/skc_library/build_scripts/ && ./skc_library_build.sh

skc_installer:
	cd sgx-caching-service && make installer
	cd sgx-hvs && make installer
	cd sgx-verification-service && make installer

skc_k8s:
	cd sgx-caching-service && make k8s
	cd sgx-hvs && make k8s
	cd sgx-verification-service && make k8s

intel_secl_k8s:
	cd intel-secl && make k8s

$(COMMON_TARGETS):
	cd intel-secl && make $@-installer && make aas-manager

sgx_agent_k8s:
	cd utils/build/skc-tools/sgx_agent/build_scripts/ && ./build_sgx_agent_docker.sh

skc_library_k8s:
	cd utils/build/skc-tools/skc_library/build_scripts/ && ./build_skclib_docker.sh

k8s_extensions:
	cd k8s-extensions && make all

k8s_common:
	mkdir -p k8s/container-images
	mkdir -p k8s/manifests
	mkdir -p k8s/platform-dependencies
	cp -r utils/build/skc-tools/sgx_agent/agent_untar.sh k8s/platform-dependencies/
	cp -r utils/build/skc-tools/sgx_agent/build_scripts/sgx_agent.tar k8s/platform-dependencies/
	cp -r utils/build/skc-tools/sgx_agent/build_scripts/sgx_agent.sha2 k8s/platform-dependencies/
	cp -r utils/build/skc-tools/sgx_agent/deploy_scripts/agent_container_prereq.sh k8s/platform-dependencies/
	cp -r utils/build/skc-tools/sgx_agent/deploy_scripts/deployment_prerequisites.sh k8s/platform-dependencies/
	cp -r utils/build/skc-tools/skc_k8s/pre-requisites.sh k8s/manifests/
	cp -r utils/build/skc-tools/skc_k8s/db-deployments/skc-bootstrap-db-services.sh k8s/manifests/skc-bootstrap-db-services.sh
	cp -r utils/build/skc-tools/skc_k8s/sgx_agent k8s/manifests/sgx_agent
	cp  utils/build/skc-tools/skc_library/deploy_scripts/create_roles.conf utils/build/skc-tools/skc_k8s/skc_library/resources/
	cp  utils/build/skc-tools/skc_library/deploy_scripts/skc_library_create_roles.sh utils/build/skc-tools/skc_k8s/skc_library/resources/
	cp  utils/build/skc-tools/skc_library/deploy_scripts/skc_library.conf utils/build/skc-tools/skc_k8s/skc_library/resources/
	cp -r utils/build/skc-tools/skc_k8s/skc_library k8s/manifests/skc_library
	cp -r utils/build/skc-tools/skc_k8s/k8s-extensions-controller k8s/manifests/
	cp -r utils/build/skc-tools/skc_k8s/k8s-extensions-scheduler k8s/manifests/
	cp -r utils/build/skc-tools/skc_k8s/skc-bootstrap.sh k8s/manifests/skc-bootstrap.sh
	cp utils/build/skc-tools/skc_k8s/isecl-skc-k8s.env k8s/manifests/isecl-skc-k8s.env
	cp -r intel-secl/deployments/container-archive/oci/*.tar k8s/container-images/
	mkdir -p k8s/manifests/aas/scripts
	cp -r utils/build/skc-tools/kbs_script k8s/manifests/kbs/
	cp k8s-extensions/out/isecl-k8s-extensions/*.tar k8s/container-images/
	cp sgx-caching-service/out/*.tar k8s/container-images/
	cp sgx-verification-service/out/*.tar k8s/container-images/
	cp sgx-hvs/out/*.tar k8s/container-images/
	cp sgx_agent/out/*.tar k8s/container-images/
	cp skc_library/out/*.tar k8s/container-images/

%-clean:
	cd $* && make clean
	cd intel-secl && make clean

.PHONY: all clean sgx_agent skc_library $(COMMON_TARGETS)
